/**
 * first generate the Makefile using goil:
 * -> goil -g --target=arm/armadeus_apf9328 --templates=../../../goil/templates/ -i  armadeus_apf9328.oil
 * Then compile your project:
 * -> make
 * (make will call the OIL compiler 'goil' each time that is necessary. You do not need to call
 * goil directly.
 * The Executable file is an .elf file. A .bin is also generated by the Makefile to use
 * with uBoot: armadeus_apf9328_exe.bin
 *
 * This demo uses to LED on the dev full ARMadeus card.
 * Timer 1 is associated to 1 system counter and blink the LED.
 * Timer 2 is associated to 1 ISR2 that start/stop the alarm.
 */

#include "tpl_os.h" //OSEK system calls.
#include "timer.h"  //specific function to handle timers.
#include "interrupt.h" //specific interrupt management.

#define APP_Task_task1_START_SEC_CODE
#include "tpl_memmap.h"

#define LEDON  (1<<14)
#define LEDOFF (~LEDON)
#define ADRESSELED  (unsigned int*)0x21c300

void ledOn(){
	(*ADRESSELED) = LEDON;
}

void ledOff(){
	(*ADRESSELED) = LEDOFF;
}

//pause during 'delay' seconds, using the RTC
//delay SHOULD be < 60s.
//This method modify RTC registers !!

//RTC Seconds Counter Register
#define ADRESSETIME (unsigned int*)0x204004
void pause(int delay)
{
	(*ADRESSETIME) = 0; //init value: Warning: update RTC registers!!
	while((*ADRESSETIME) <= delay);
}

FUNC(int, OS_APPL_CODE) main(void)
{
	//start timer 1 period 1000us = 1ms associated to counter.
	timerInitWithPeriodicUS(1,1000);
	//start timer 2 period 3000000us = 3s. related to ISR2.
	timerInitWithPeriodicUS(2,3000000);
	//set both interrupt sources.
	initIT();
	initNormalInterrupt(TIMER1_IT, 2); //timer 1, priority 2
	initNormalInterrupt(TIMER2_IT, 3); //timer 2, priority 3
    StartOS(OSDEFAULTAPPMODE);
    return 0;
}

//periodic task.
TASK(task1)
{
	static unsigned int blink = 0;
	if(blink) {
		ledOn();
		blink = 0;
	} else {
		ledOff();
		blink = 1;
	}
	TerminateTask();
}

DeclareAlarm(Alarm1);

/** Periodic stuff should be implemented using counter and alarms.
 *  This one uses both counter/alarm with Timer1 and ISR2 with Timer2
 *  for deminstration purpose
 */
ISR(isrTimer2)
{
	static unsigned int stop = 1;
	if(stop) 
	{
		CancelAlarm(Alarm1);
		stop = 0;
	} else {
		SetRelAlarm(Alarm1, 1, 50);
		stop = 1;
	}
}

#define APP_Task_task1_STOP_SEC_CODE
#include "tpl_memmap.h"

