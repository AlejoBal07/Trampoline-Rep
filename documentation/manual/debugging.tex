%!TEX root = ./main.tex

\chapter{Debugging an application}

%\section*{Introduction}

Debugging an application requires examining the internal structures of Trampoline. The information contained in these structures can be used to find out which task is running, which tasks are ready, which resources are held, the status of alarms, etc. Finding one's way around these data structures can be difficult for a user. 

As GDB is the most frequently used debugger, it is possible for GDB to generate a command file to simplify the examination of the internal structures of Trampoline.

\section{Command generation}

The OIL object \oilobj{OS} has the boolean attribute \oilattr{GDBCOMMANDS} which, when true, leads to the generation of a file named \file{commands.gdb} in the same directory as the OIL file. An optionnal sub-attribute, \oilattr{PORT}, is used to specify the TCP/IP port on which the GDB server is listening and to generate the commands allowing GDB to connect to the GDB server, to load the program on the target and to set a breakpoint on the \cfunction{main}. For example:

\begin{lstlisting}[language=OIL]
GDBCOMMANDS = TRUE
{
    PORT = 4242;
};
\end{lstlisting}

may be used on STMicroelectronics MCU (port 4242 is the default port of ST-LINK debugging system). 

\section{Examining the tasks}

For each task declared in the OIL file, 2 commands named \com{b_<task name>} and \com{_<task name>} are generated. The first command sets a breakpoint on the task. The second command displays the name of the task, its identifier and its type (basic or extended) as well as:

\begin{pitemize}
\item its state, \SUSPENDED, \READY, \RUNNING\ or \WAITING;
\item its priority in the form \comoutput{<current priority>/<basic priority>};
\item its activation count in the form \comoutput{<current activation>/<maximum activation>};
\item its internal resource if it exists. For a non-preemptible task, \comoutput{INTERNAL_RES_SCHEDULER} is displayed. If the task has no internal resource, \comoutput{NONE} is displayed.
\item a list of resources that the task holds. The list is displayed between a pair of square brackets from the most recently taken resource to the oldest taken resource. If no resource is held, only the pair of brackets is displayed. 
\end{pitemize}

Suppose, for example, that the OIL file declares a task named \oilobj{blink} as shown below.

\begin{lstlisting}[language=OIL]
TASK blink {
    PRIORITY = 1;
    AUTOSTART = FALSE;
    ACTIVATION = 1;
    SCHEDULE = FULL;
    RESOURCE = r1;
    RESOURCE = r2;
};
\end{lstlisting}

and that the C code of the task \cfunction{blink} is the following:

\begin{lstlisting}[language=C,escapechar=|,numbers=left]
TASK(blink)
{
    GetResource(r1);
    GetResource(r2);
    ledToggle(GREEN);|\label{bp:between-rez}|
    ReleaseResource(r2);
    ReleaseResource(r1);|\label{bp:after-rez2-release}|
    TerminateTask();
}
\end{lstlisting}
 
and that a breakpoint has been set at the line \ref{bp:between-rez}. The command \com{_blink} will be generated and if invoked at the breakpoint it would display the following result:

\begin{lstlisting}
(gdb) _blink 
Task blink (id = 0, BASIC):
	state             = RUNNING
	priority          = 2/1
	activate_count    = 1/1
	internal_resource = NONE
	resources         = [ r2 r1 ]
\end{lstlisting} 

\warning{If the command is performed before reaching \cfunction{main}, i.e. possibly before the copy of the initialized variables has taken place, the variables may not be initialized yet and the state, the current priority or the current number of activations will be wrong. In addition, the pointer to the head of the list of resources held will be wrong, which may lead to an error message from GDB. If the task is in the \SUSPENDED\ state, its priority is meaningless.}

\section{Examining the resources}

For each resource, a command named \com{_<resource name>} is generated. This command displays the type (\oilval{STANDARD} or \oilval{INTERNAL}) of the resource, its name and identifier as well as for standard resources:

\begin{pitemize}
\item its ceiling priority;
\item the name of the owning process. If the resource is not held, \comoutput{NONE} is displayed;
\item if the resource is held, the previous priority of the process holding it is displayed.
\end{pitemize}

For an internal resource the following information is displayed:

\begin{pitemize}
\item its ceiling priority;
\item if the resource is held;
\item if the resource is held, the previous priority of the process holding it is displayed.
\end{pitemize}

Let's continue with the previous example. The execution of the command \com{_r2} when the execution has reached the line \ref{bp:between-rez} would display:

\begin{lstlisting}
(gdb) _r2
Resource r2 (id = 0, STANDARD):
	ceiling priority    = 2
	owner               = blink
	owner prev priority = 2
\end{lstlisting} 

After reaching the line \ref{bp:after-rez2-release}, the execution of the command \com{_r2} would display:

\begin{lstlisting}
(gdb) _r2
Resource r2 (id = 0, STANDARD):
	ceiling priority    = 2
	owner               = NONE
\end{lstlisting} 

The following example shows the display of internal resource \oilval{oups} according to whether it is not held:

\begin{lstlisting}
(gdb) _oups 
Resource oups (INTERNAL):
	ceiling priority    = 4
	taken               = 0
\end{lstlisting} 

or held:

\begin{lstlisting}
(gdb) _oups 
Resource oups (INTERNAL):
	ceiling priority    = 4
	taken               = 1
	owner prev priority = 3
\end{lstlisting} 

\section{Examining alarms}

For each alarm, a command \com{_<alarm name>} is generated. The command displays the alarm identifier as well as the following information:

\begin{pitemize}
\item the counter to which it is linked with the current date of the counter in brackets;
\item son Ã©tat (\comoutput{SLEEP}, \comoutput{ACTIVE} ou \comoutput{AUTOSTART}\footnote{This state is only possible before starting the OS.});
\item if the alarm is \comoutput{ACTIVE}, its expiry date;
\item if the alarm is \comoutput{ACTIVE} and cyclic, its cycle;
\item finally its action.
\end{pitemize}

The following output is an example of an alarm display:

\begin{lstlisting}
(gdb) _blink_alarm 
Alarm blink_alarm (id = 0):
	counter = SystemCounter (1461)
	state   = ACTIVE
	date    = 1561
	cycle   = 100
	action  = ACTIVATETASK
\end{lstlisting}
